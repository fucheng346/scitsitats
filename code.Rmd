---
title: "scitsitats"
output: html_document
date: "2025-10-20"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

## Problem Statement

Build a model to predict medical insurance charges and identify the key factors influencing increasing healthcare costs.


```{r Load Libraries, Load Data, include=FALSE}
library(dplyr)   # For data manipulation
library(tidyr)   # For data tidying
library(car)
library(caret)
library(knitr)
library(rcompanion)
library(psych)

setwd ("C:/Users/fuche/Desktop/New folder/scitsitats")

```

```{r Load Data, echo=TRUE}
df <- read.csv("medical insurance.csv")
```


## Data Visualisation

a. EDA - Response variable: charges

```{r EDA for response var, echo=TRUE}
h.charges <- hist(df$charges, 
            main = "Histogram of Medical Insurance Cost", 
            labels = TRUE, 
            xlab = "Charges",
            ylab = "No. of Beneficiaries", 
            col = "darkblue", 
            xlim = c(0, 65000), 
            ylim = c(0, 400),
            xaxp = c(0, 65000, 13))

charges.group <- cut(df$charges, breaks = h.charges$breaks, include.lowest = TRUE, dig.lab = 5)
charges_freq <- table(charges.group)
kable(charges_freq, caption = "Frequency Distribution by Medical Insurance Cost")


plot(density(df$charges), main="Density plot for Medical Insurance Cost")

qqnorm(df$charges, 
       main="Normal Q-Q Plot for charges")
qqline(df$charges, col=4)

shapiro.test(df$charges) 
# H0: Data was drawn from a normally distributed population
# W = 0.81469, is quite far from 1
# Given p < 2.2e-16 < 0.05, there is sufficient evidence to reject H0. 
# Hence, we can conclude data is not normally distributed.

```

[From the histogram, the distribution of charges is right skewed. From the Shapiro-Wilk test, given p-value < 2.2e-16 < 0.05 and W = 0.81469 which is quite far from 1, we have sufficient evidence to reject H0 that the data is normally distributed and conclude that charges is not normally distributed.]{style="color:blue"}

```{r outlier analysis for response var, echo=TRUE}
bcharges3 <- boxplot(df$charges, 
              range = 3, 
              main = "Boxplot of charges with Range = 3")

bcharges1.5 <- boxplot(df$charges, 
                 range = 1.5, 
                 main="Boxplot of charges with Range = 1.5")
# extreme outliers are those in bX3$out
bcharges3$out
length(bcharges3$out)
min(bcharges3$out)
max(bcharges3$out)

length(bcharges1.5$out)
min(bcharges1.5$out)

# moderate outliers are those in bX1.5$out but not in bX3$out 
# We can use setdiff() to find the difference in two vectors

charges_out.mild <- setdiff(bcharges1.5$out, bcharges3$out)
max(charges_out.mild)

# moderate outliers are of these values: "insert values"
``` 

[Distribution seems to be right skewed resulting in the boxplot picking up a lot of outliers. Extreme medical charges may be valid and important for modeling, so we will keep the outliers and transform charges.]{style="color:blue"}


```{r transform charges, echo=TRUE}
df$charges.t = transformTukey(df$charges, plotit=TRUE)

```

[Given right-skewed distribution of charges as shown in histogram, transformations would be applied to make distribution of charges closer to normality. Using Tukey transformation, we obtain a transformation for charges to be x^0.025, where x == df1$charges, to make distribution of charges closer to normality. This corroborates with the histogram of transformed charges which follows the normal distribution curve largely and the QQ-plot of transformed charges which closely follows the diagonal line, suggesting transformed charges variable follows normality more closely.]{style="color:blue"}


b. EDA - Explanatory variables:

[There are 6 variables we are interested in exploring, particularly age, sex, bmi, children, their status as a smoker and their residential region in the US. Age (i.e. that of primary beneficiaries) is a ratio variable. Sex (i.e. gender of primary beneficiaries) is a categorical variable. BMI is a ratio variable. The number of children covered by health insurance highlighted by variable `children` is a ratio variable. Their status as a smoker is a categorical variable. Their residential region in the US is a categorical variable. ]{style="color:blue"}

Applying data visualisation methods, we find that:

- age

```{r eda for age, echo=TRUE}
h.age <- hist(df$age, 
            main = "Histogram of Age of Primary Beneficiary", 
            labels = TRUE, 
            xlab = "Age",
            ylab = "No. of Beneficiaries", 
            col = "darkred", 
            xlim = c(15, 65), 
            ylim = c(0, 200),
            xaxp = c(15, 65, 10))

age.group <- cut(df$age, breaks = h.age$breaks, include.lowest = TRUE, dig.lab = 5)
age_freq <- table(age.group)
kable(age_freq, caption = "Frequency Distribution by Age of Primary Beneficiary")

plot(density(df$age), main="Density plot for Age of Primary Beneficiary")

qqnorm(df$age, 
       main="Normal Q-Q Plot for age")
qqline(df$age, col=2)

```

[From the histogram, we see that the frequency distribution of primary beneficiaries across ages is relatively balanced between the ages of 20 and 60. We see that the extreme low values are higher whereas the extreme high values of age are considerably lower (the number of beneficiaries aged between 60 and 65 is almost half of the number of beneficiaries who are aged between 15 and 20). This is similarly highlighted in the density plot where we see that there are fewer extreme points as compared to a normal distribution curve. Using the value of excess kurtosis at -1.25, we find that the distribution of age is platykurtic with a ligher tail (i.e. fewer extreme points).]{style="color:blue"}

- sex

```{r eda for sex, echo=TRUE}
sexFreq <- df %>% 
  count(sex)

kable(sexFreq, caption = "Frequency of Beneficiaries by Gender")

slice.sex <- sexFreq$n
sex.piepercent <- 100 * round(sexFreq$n / sum(sexFreq$n), 4)
label <- paste(sexFreq$sex, ",", sep = "", sex.piepercent, "%")
pie(slice.sex, 
    labels = label, 
    col = c("blue", "cyan"),
    radius = 1,
    main = "Frequency of Beneficiaries by Gender")

```


[From the pie chart, we see that there is a balance across genders. The percentage of female insurance beneficiaries is approximately equal to the percentage of male insurance beneficiaries, with there being 1.04% of primary insurance beneficiaries being male as compared to those who are female. We can hence infer that the gender of beneficiaries has little impact on their probability of buying insurance.]{style="color:blue"}

- bmi

```{r eda for bmi, echo=TRUE}
h.bmi <- hist(df$bmi, 
            main = "Histogram of Body Mass Index", 
            labels = TRUE, 
            xlab = "Body Mass Index",
            ylab = "No. of Beneficiaries", 
            col = "orange", 
            xlim = c(15, 55), 
            ylim = c(0, 500),
            xaxp = c(15, 55, 8))

bmi.group <- cut(df$bmi, breaks = h.bmi$breaks, include.lowest = TRUE, dig.lab = 5)
bmi_freq <- table(bmi.group)
kable(bmi_freq, caption = "Frequency Distribution by Body Mass Index")

plot(density(df$bmi), main="Density plot for BMI")

qqnorm(df$bmi, 
       main="Normal Q-Q Plot for BMI")
qqline(df$bmi, col=3)

```

[FOR BMI: From the histogram, we see that the Body Mass Index (BMI) of primary beneficiaries is relatively normal, with majority of primary beneficiaries having a BMI of between 20 and 45. There are 3 extreme points of BMI found between 50 and 55, which can be considered outliers. This corroborates with the QQ-plot which closely follows the diagonal line. As the sample size here is large, although extreme values deviate from the diagonal line, it is not statistically significant.]{style="color:blue"}

- children

```{r eda for children, echo=TRUE}

childFreq <- df %>% 
  count(children)

kable(childFreq, caption = "Frequency of Beneficiaries by Children Covered by Health Insurance")


childbar <- childFreq$n

barplot(childbar,
        names.arg = childFreq$children,
        col="violet", 
        main="Frequency of Beneficiaries by Children Covered by Health Insurance",
        ylim=c(0,600), 
        ylab="No. of Beneficiaries",
        xlab = "No. of Children")

```

[Based on the bar chart, we see that the number of primary beneficiaries across the number of children which the primary beneficiary has is not balanced. We see that the number of primary beneficiaries is the highest among those with no children and lowest among those with 5 children. Beneficiaries with 0 to 3 children make up majority of primary beneficiaries.]{style="color:blue"}

- smoker

```{r eda for smoker, echo=TRUE}
smokeFreq <- df %>% 
  count(smoker)

kable(smokeFreq, caption = "Frequency of Beneficiaries by Smoking Status")

slice.smoke <- smokeFreq$n
smoke.piepercent <- 100 * round(smokeFreq$n / sum(smokeFreq$n), 4)
label <- paste(smokeFreq$smoker, ",", sep = "", smoke.piepercent, "%")
pie(slice.smoke, 
    labels = label, 
    col = c("blue", "cyan"),
    radius = 1,
    main = "Frequency of Beneficiaries by Smoking Status")

```

[From the pie chart, we see that majority (79.52%) of primary insurance beneficiaries do not smoke. However, we do not need to consider grouping smokers as a rare category since both are reasonably well represented and large enough for stable estimation, and we would likely lose interpretability if we grouped them differently.]{style="color:blue"}

- region

```{r eda for region, echo=TRUE}
regionFreq <- df %>% 
  count(region)

kable(regionFreq, caption = "Frequency of Beneficiaries by Residential Region in the US")


regionbar <- regionFreq$n

region_bp <- barplot(regionbar,
                     names.arg = regionFreq$region,
                     col="darkred", 
                     main="Frequency of Beneficiaries by Residential Region in the US",
                     ylim=c(0,400), 
                     ylab="No. of Beneficiaries",
                     xlab = "Residential Region",
                     width = c(0.5, 0.5),
                     space = 2)

text(x=region_bp, y=regionbar, labels=round(regionbar,0), pos=3, xpd=NA)


```

[Based on the bar chart, we see that that the frequency of beneficiaries across residential regions in the US is relatively balanced, with the number of beneficiaries per residential region being approximately 330.]{style="color:blue"}


## Association between Transformed Charges and age, bmi, children

[We check whether assumptions of linearity, etc. are met before fitting the data into a multiple regression model.]{style="color:blue"}

- Transformed Charges against age

```{r Transformed Charges against age, echo=TRUE}
plot(df$age,
     df$charges.t, 
     main = "Scatterplot of Age vs Transformed Charges", 
     xlab = "Age", 
     ylab = "Transformed Charges",
     pch = 1) 

```

[From the scatterplot of age VS transformed charges, we see that there is a non-linear positive association between transformed charges and age. This corroborates with the correlation coefficient of 0.13 < 0.30 which is positive, hence suggesting a weak linear relationship between age and transformed charges. Since p-value = 0 < 0.05, this correlation is statistically significant at the 0.05 level of significance. Hence, age has to be transformed before fitting a multiple linear regression model to ensure the linearity assumption is not violated.]{style="color:blue"}

- Transformed Charges against bmi

```{r Transformed Charges against bmi, echo=TRUE}
plot(df$bmi,
     df$charges.t, 
     main = "Scatterplot of BMI vs Transformed Charges", 
     xlab = "BMI", 
     ylab = "Transformed Charges",
     pch = 2) 

```

[From the scatterplot of BMI vs Transformed charges, points are randomly scattered and we see no discernible pattern hence association between transformed charges and BMI.]{style="color:blue"}

- Transformed Charges against children

```{r Transformed Charges against children, echo=TRUE}
plot(df$children,
     df$charges.t, 
     main = "Scatterplot of Number of Children vs Transformed Charges", 
     xlab = "Number of Children", 
     ylab = "Transformed Charges",
     pch = 3) 

```

[The scatterplot shows that transformed charges remain relatively stable across different numbers of children, with a slight upward trend. No clear linear relationship is evident]{style="color:blue"}

- correlation matrix

```{r correlation matrix, echo=TRUE}
df.num <- df %>%
  select(charges.t, age, bmi, children)
corr.test(df.num)
```

[We examined the variables BMI and children for potential transformations to improve linearity with the transformed response variable (charges.t). BMI was already approximately normally distributed, and no simple transformations (log, square root, polynomial, Tukey) produced a linear relationship with the transformed response. Similarly, children is a discrete count variable, and attempts at transformations did not produce a linear trend. Therefore, both variables were retained in their original form for modeling in order to preserve interpretability.]{style="color:blue"}

## Association between Transformed Charges and sex, smoker, region

- Transformed Charges against sex

```{r Transformed Charges against sex, echo=TRUE}
bcharges.sex <- boxplot(df$charges.t~df$sex, 
               horizontal = TRUE,
               xlab = "Transformed Charges", 
               ylab = "Sex",
               main = "Boxplot of Transformed Charges against Sex",
               col = "orange")

```

- Transformed Charges against smoker

```{r Transformed Charges against smoker, echo=TRUE}
bcharges.smoker <- boxplot(df$charges.t~df$smoker, 
               horizontal = TRUE,
               xlab = "Transformed Charges", 
               ylab = "Smoker",
               main = "Boxplot of Transformed Charges against Smoking Status",
               col = "pink")

cor.test(df$charges.t, as.numeric(df$smoker == "yes"))

```

- Transformed Charges against region

```{r Transformed Charges against region, echo=TRUE}
bcharges.region <- boxplot(df$charges.t~df$region, 
               horizontal = TRUE,
               xlab = "Transformed Charges", 
               ylab = "Region",
               main = "Boxplot of Transformed Charges against Region",
               col = "violet")

```

[For both categorical variables sex and region, the median and spread are similar in each group. Therefore, transformed charges is not associated with both variables. For categorical variable smoker, the median and spread are different in each group. Therefore, transformed charges is associated with smoker.]{style="color:blue"}


## Associations between Transformed Charges and Transformed Age

- Transformed Charges against Transformed Age

```{r Transformed Charges against log10(age), echo=TRUE}
df$age.t = log10(df$age)

plot(df$age.t,
     df$charges.t, 
     main = "Scatterplot of Transformed Age vs Transformed Charges", 
     xlab = "Transformed Age", 
     ylab = "Transformed Charges",
     pch = 1) 

cor.test(df$charges.t, df$age.t)

```

[The scatterplot with the fitted linear trend shows that `charges.t` and `age.t` have an approximately linear relationship after transformation, supporting the use of linear regression.]{style="color:blue"}



## Interactions between explanatory variables

Association between variables is checked to identify potential interaction terms. 

- age against sex

```{r age against sex, echo=TRUE}
bage.sex <- boxplot(df$age~df$sex, 
               horizontal = TRUE,
               xlab = "Age", 
               ylab = "Sex",
               main = "Boxplot of Age against Sex")

```

[no association]{style="color:blue"}

- age against bmi

```{r age against bmi, echo=TRUE}
plot(df$bmi,
     df$age, 
     main = "Scatterplot of Age vs BMI", 
     xlab = "bmi", 
     ylab = "Age",
     pch = 6) 

```

[no association]{style="color:blue"}

- age against children

```{r age against children, echo=TRUE}
plot(df$children,
     df$age, 
     main = "Scatterplot of Age vs Number of Children", 
     xlab = "Number of Children", 
     ylab = "Age",
     pch = 6)

```

[no association]{style="color:blue"}

- age against smoker

```{r age against smoker, echo=TRUE}
bage.smoke <- boxplot(df$age~df$smoker, 
               horizontal = TRUE,
               xlab = "Age", 
               ylab = "Smoking Status",
               main = "Boxplot of Age against Smoking Status")

```

[some association]{style="color:blue"}

- age against region

```{r age against region, echo=TRUE}
bage.region <- boxplot(df$age~df$region, 
               horizontal = TRUE,
               xlab = "Age", 
               ylab = "Region",
               main = "Boxplot of Age against Region")

```

[no association]{style="color:blue"}

- bmi against sex

```{r bmi against sex, echo=TRUE}
bbmi.sex <- boxplot(df$bmi~df$sex, 
               horizontal = TRUE,
               xlab = "BMI", 
               ylab = "Sex",
               main = "Boxplot of BMI against Sex")

```

[no association]{style="color:blue"}

- children against sex

```{r children against sex, echo=TRUE}
bchildren.sex <- boxplot(df$children~df$sex, 
               horizontal = TRUE,
               xlab = "Number of Children", 
               ylab = "Sex",
               main = "Boxplot of Number of Children against Sex")

```

[no association]{style="color:blue"}

- sex against smoker

```{r sex against smoker, echo=TRUE}
sex_smoker <- df %>% 
  count(sex, smoker)

sex_smoker.spread <- sex_smoker %>% 
  spread(key = smoker, value = n, fill = 0)

sex_smoker.spread[is.na(sex_smoker.spread)] <- 0 

kable(sex_smoker.spread, caption = "Contingency table for Sex and Smoking Status")

sex_smoker.barmatrix <- as.matrix(sex_smoker.spread[,c(2, 3)]) 

bar_Col <- c("pink","brown")

barplot(sex_smoker.barmatrix,
        names.arg = c("yes", "no"), 
        col = bar_Col, 
        beside = TRUE, 
        ylim = c(0,700), 
        ylab = "Number of Beneficiaries",
        main = "Frequency of Females / Males by Smoking Status") 

legend("topright", 
       fill = bar_Col, 
       legend = sex_smoker.spread$sex, 
       title = "Sex")

```

[no association]{style="color:blue"}

- region against sex

```{r region against sex, echo=TRUE}
region_sex <- df %>% 
  count(sex, region)

region_sex.spread <- region_sex %>% 
  spread(key = region, value = n, fill = 0)

region_sex.spread[is.na(region_sex.spread)] <- 0 

kable(region_sex.spread, caption = "Contingency table for Sex and Region")

region_sex.barmatrix2 <- as.matrix(region_sex.spread[,c(2:5)]) 

bar_Col2 <- c("pink","brown")

barplot(region_sex.barmatrix2,
        names.arg = c("northeast", "northwest", "southeast", "southwest"), 
        col = bar_Col2, 
        beside = TRUE, 
        ylim = c(0,300), 
        ylab = "Number of Beneficiaries",
        main = "Frequency of Females / Males by Region") 

legend("topright", 
       fill = bar_Col2, 
       legend = region_sex.spread$sex, 
       title = "Sex") 

```

[no association]{style="color:blue"}

- bmi against children

```{r bmi against children, echo=TRUE}
plot(df$children,
     df$bmi, 
     main = "Scatterplot of No. of Children vs BMI", 
     xlab = "No. of Children", 
     ylab = "BMI",
     pch = 6) 

```

[no association]{style="color:blue"}

- bmi against smoker

```{r bmi against smoker, echo=TRUE}
bbmi.smoke <- boxplot(df$bmi~df$smoke, 
               horizontal = TRUE,
               xlab = "BMI", 
               ylab = "Smoking Status",
               main = "Boxplot of BMI against Smoking Status")

```

[no association]{style="color:blue"}

- bmi against region

```{r bmi against region, echo=TRUE}
bbmi.region <- boxplot(df$bmi~df$region,
               xlab = "BMI", 
               ylab = "Region",
               main = "Boxplot of BMI against Region")

```

[some association for southeast (?)]{style="color:blue"}

- children against smoker

```{r children against smoker, echo=TRUE}
bchild.smoker <- boxplot(df$children~df$smoker,
               xlab = "Number of Children", 
               ylab = "Smoking Status",
               main = "Boxplot of Number of Children against Smoking Status")

```

[no association]{style="color:blue"}

- children against region

```{r children against region, echo=TRUE}
bchild.region <- boxplot(df$children~df$region,
               xlab = "No. of Children", 
               ylab = "Region",
               main = "Boxplot of No. of Children against Region")

```

[no association]{style="color:blue"}

- smoker against region

```{r smoker against region, echo=TRUE}
smoker_region <- df %>% 
  count(smoker, region)

smoker_region.spread <- smoker_region %>% 
  spread(key = region, value = n, fill = 0)

smoker_region.spread[is.na(smoker_region.spread)] <- 0 

kable(smoker_region.spread, caption = "Contingency table for Smoking Status and Region")

smoker_region.barmatrix <- as.matrix(smoker_region.spread[,c(2:5)]) 

bar_Col3 <- c("gray","pink")

barplot(smoker_region.barmatrix,
        names.arg = c("northeast", "northwest", "southeast", "southwest"), 
        col = bar_Col3, 
        beside = TRUE, 
        ylim = c(0,300), 
        ylab = "Number of Beneficiaries",
        main = "Frequency of Smokers by Region") 

legend("topright", 
       cex = 0.5,
       fill = bar_Col3, 
       legend = smoker_region.spread$smoker, 
       title = "Smoking Status") 

```


[no association]{style="color:blue"}



## Prediction

```{r setup for linear regression, echo = TRUE}
set.seed(123)
train_rows <- sample(nrow(df), 0.8 * nrow(df))
df_train <- df[train_rows, ]
df_test <- df[-train_rows, ]
```

Build regression models to predict insurance charges using features like age, BMI, smoking habits and region.

a. Baseline Model

Response variable vs the most strongly correlated explanatory variables - smoker and age

Let c, s, a denote charges.t, smoker, age.t respectively. For smoker, the reference category is “yes”.

```{r Baseline Model, echo=TRUE}

# Convert the 'smoker' variable to a factor. The category "yes" is set as the reference group.
df_train$smoker <- factor(df_train$smoker, levels=c("yes", "no"))
df_train$smoker <- relevel(df_train$smoker, ref="yes")
contrasts(df_train$smoker)

mod.base <- lm(charges.t ~ smoker + age.t, data = df_train)
summary(mod.base)

``` 

[charges.t = 1.103 - (0.04819)s + (0.09174)a]

[The multiple R-squared statistic (0.7406) indicates that 74.06% of the variation in the dependent variable (charges.t) is explained by the independent variables (smoker and age.t). This suggests that other factors not included in the model might also influence medical insurance charges.]

c. Building Improved Models

To improve upon our baseline model (`charges.t ~ smoker + age.t`), we use **forward stepwise selection**. 
By using this method, we can determine whether adding variables like BMI, number of children, sex, or region meaningfully improves our baseline model.

```{r Creating Dummy Variables, echo=TRUE}
# Convert the 'sex' variable to a factor. The category "female" is set as the reference group.
df_train$sex <- factor(df_train$sex, levels=c("female", "male"))
df_train$sex <- relevel(df_train$sex, ref="female")
contrasts(df_train$sex)


# Convert the 'region' variable to a factor. The category "northeast" is set as the reference group.
df_train$region <- factor(df_train$region, levels=c("northeast", "northwest", "southeast", "southwest"))
df_train$region <- relevel(df_train$region, ref="northeast")
contrasts(df_train$region)
```


```{r Forward Stepwise Model Selection, echo=TRUE}
step(mod.base, scope = ~ age.t + smoker + sex + bmi + children + region + bmi*region + age.t*smoker, direction = "forward", trace = 1)

``` 
```{r build model, echo=TRUE}
mod <- lm(formula = charges.t ~ smoker + age.t + children + bmi + region + sex + smoker:age.t, data = df_train)

summary(mod)

```

```{r check multicollinearity, echo=TRUE}
vif(mod, type = "predictor")

``` 

```{r model test, echo=TRUE}

df_test$pred_charges.t <- predict(mod, newdata = df_test)

test_rmse <- sqrt(mean((df_test$charges.t - df_test$pred_charges.t)^2))

test_mae <- mean(abs(df_test$charges.t - df_test$pred_charges.t))

test_r2 <- 1 - sum((df_test$charges.t - df_test$pred_charges.t)^2) / sum((df_test$charges.t - mean(df_test$charges.t))^2)

test_rmse
test_mae
test_r2

``` 

[The coefficient of determination R-squared (0.8194) indicates that 81.94% of the variation in the dependent variable (charges.t) is explained by the predictors included in the model, namely smoker status, age, number of children, BMI, sex, and region. This indicates that the selected predictors capture the majority of the variation in medical insurance charges, highlighting their strong influence on costs.]









